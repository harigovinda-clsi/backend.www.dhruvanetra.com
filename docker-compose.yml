version: '3.8'

# DhruvaNetra Development Environment
# Complete observatory setup for local experimentation

services:
  # MongoDB - The memory keeper
  mongodb:
    image: mongo:7.0
    container_name: dhruva_netra_db
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: dhruva_netra
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - observatory_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Backend API - The observer
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dhruva_netra_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Database connection
      MONGODB_URL: mongodb://mongodb:27017
      DATABASE_NAME: dhruva_netra
      
      # NASA API (replace DEMO_KEY with your own key for production)
      NASA_API_KEY: ${NASA_API_KEY:-DEMO_KEY}
      
      # Security (generate secure values for production)
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this-in-production}
      
      # Application settings
      PORT: 8000
      
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - observatory_network
    volumes:
      - ./main.py:/app/main.py  # For development hot-reload
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-level info

# Persistent storage - memories that endure
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

# Isolated network - controlled communication
networks:
  observatory_network:
    driver: bridge